name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Scan tracked files for obvious secrets
        run: |
          python - <<'PY'
          import re
          import subprocess
          import sys
          from pathlib import Path

          patterns = [
              r"AIza[0-9A-Za-z_-]{20,}",
              r"GOCSPX-[A-Za-z0-9_-]{10,}",
              r"-----BEGIN (?:RSA|EC|OPENSSH|DSA|PGP) PRIVATE KEY-----",
          ]
          combined = re.compile("|".join(patterns))

          files = subprocess.check_output(["git", "ls-files"], text=True).splitlines()
          findings = []
          for rel in files:
              path = Path(rel)
              try:
                  text = path.read_text(encoding="utf-8", errors="ignore")
              except Exception:
                  continue
              for lineno, line in enumerate(text.splitlines(), start=1):
                  if combined.search(line):
                      findings.append(f"{rel}:{lineno}: potential secret pattern")

          if findings:
              print("Potential hardcoded secrets found:")
              for item in findings:
                  print(item)
              sys.exit(1)
          print("No obvious secret patterns found in tracked files.")
          PY

  backend-tests:
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend deps + pytest
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest

      - name: Run pytest (API/auth/privacy)
        run: pytest

  frontend-unit-build:
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install frontend test tooling
        run: npm install --no-save vitest jsdom

      - name: OpenAPI generated client is up to date
        run: npm run openapi:check

      - name: Lint frontend
        run: npm run lint

      - name: Run Vitest unit tests
        run: npm run test:unit

      - name: Build frontend
        run: npm run build

  playwright-e2e:
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-unit-build]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install frontend deps
        run: npm ci

      - name: Install Playwright test tooling
        run: npm install --no-save @playwright/test playwright

      - name: Build frontend for backend static serving
        run: npm run build

      - name: Install Playwright Chromium
        run: npm run test:e2e:install

      - name: Run Playwright e2e (login -> chat -> session history)
        run: npm run test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          if-no-files-found: ignore

  security-pipeline:
    runs-on: ubuntu-latest
    needs: secret-scan
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pip-audit bandit semgrep
          npm ci

      - name: Run pip-audit report
        run: pip-audit -r requirements.txt --format json --output pip-audit.json || true

      - name: Run npm audit report
        run: npm audit --json --audit-level=high > npm-audit.json || true

      - name: Run Bandit report
        run: bandit -r . -f json -o bandit.json -q || true

      - name: Run Semgrep report
        run: semgrep --config p/security-audit --config p/secrets --exclude node_modules --exclude dist --json --output semgrep.json . || true

      - name: Enforce high-severity security gate
        run: python scripts/security_gate.py --pip pip-audit.json --npm npm-audit.json --bandit bandit.json --semgrep semgrep.json
